FROM confluentinc/cp-kafka-connect:7.9.0

USER root

# Install Debezium connector
RUN confluent-hub install --no-prompt debezium/debezium-connector-postgresql:latest

# Install ClickHouse connector
RUN confluent-hub install --no-prompt clickhouse/clickhouse-kafka-connect:latest

# Download Iceberg dependencies manually
ENV ICEBERG_VERSION=1.8.1
ENV KAFKA_ICEBERG_VERSION=1.8.1
ENV NESSIE_VERSION=0.77.1
ENV AWS_SDK_VERSION=2.20.100
ENV HADOOP_VERSION=3.3.4
ENV PARQUET_VERSION=1.13.1

# Create Iceberg connector directory
RUN mkdir -p /usr/share/confluent-hub-components/iceberg-kafka-connect/lib && \
    mkdir -p /usr/share/confluent-hub-components/iceberg-kafka-connect/etc

# Download Iceberg connector and dependencies
RUN cd /tmp && \
    # Iceberg Kafka Connect Sink Connector
    curl -O https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-kafka-connect/${KAFKA_ICEBERG_VERSION}/iceberg-kafka-connect-${KAFKA_ICEBERG_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-kafka-connect-events/${KAFKA_ICEBERG_VERSION}/iceberg-kafka-connect-events-${KAFKA_ICEBERG_VERSION}.jar && \
    # Core Iceberg libraries
    curl -O https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-core/${ICEBERG_VERSION}/iceberg-core-${ICEBERG_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-api/${ICEBERG_VERSION}/iceberg-api-${ICEBERG_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-common/${ICEBERG_VERSION}/iceberg-common-${ICEBERG_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-data/${ICEBERG_VERSION}/iceberg-data-${ICEBERG_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-bundled-guava/${ICEBERG_VERSION}/iceberg-bundled-guava-${ICEBERG_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-parquet/${ICEBERG_VERSION}/iceberg-parquet-${ICEBERG_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-aws/${ICEBERG_VERSION}/iceberg-aws-${ICEBERG_VERSION}.jar && \
    # Nessie catalog
    curl -O https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-nessie/${ICEBERG_VERSION}/iceberg-nessie-${ICEBERG_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/projectnessie/nessie/nessie-client/${NESSIE_VERSION}/nessie-client-${NESSIE_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/projectnessie/nessie/nessie-model/${NESSIE_VERSION}/nessie-model-${NESSIE_VERSION}.jar && \
    # AWS SDK v2 (required for S3FileIO with Nessie)
    curl -O https://repo1.maven.org/maven2/software/amazon/awssdk/bundle/${AWS_SDK_VERSION}/bundle-${AWS_SDK_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/software/amazon/awssdk/url-connection-client/${AWS_SDK_VERSION}/url-connection-client-${AWS_SDK_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-aws-bundle/${ICEBERG_VERSION}/iceberg-aws-bundle-${ICEBERG_VERSION}.jar && \
    # Hadoop dependencies (REQUIRED for Parquet)
    curl -O https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-common/${HADOOP_VERSION}/hadoop-common-${HADOOP_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-client-api/${HADOOP_VERSION}/hadoop-client-api-${HADOOP_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-client-runtime/${HADOOP_VERSION}/hadoop-client-runtime-${HADOOP_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-auth/${HADOOP_VERSION}/hadoop-auth-${HADOOP_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-mapreduce-client-core/${HADOOP_VERSION}/hadoop-mapreduce-client-core-${HADOOP_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/commons-configuration/commons-configuration/1.10/commons-configuration-1.10.jar && \
    curl -O https://repo1.maven.org/maven2/commons-lang/commons-lang/2.6/commons-lang-2.6.jar && \
    curl -O https://repo1.maven.org/maven2/commons-collections/commons-collections/3.2.2/commons-collections-3.2.2.jar && \
    curl -O https://repo1.maven.org/maven2/com/google/protobuf/protobuf-java/3.21.12/protobuf-java-3.21.12.jar && \
    # Parquet dependencies (Updated to 1.13.1 for Iceberg 1.8.1 compatibility)
    curl -O https://repo1.maven.org/maven2/org/apache/parquet/parquet-column/${PARQUET_VERSION}/parquet-column-${PARQUET_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/parquet/parquet-hadoop/${PARQUET_VERSION}/parquet-hadoop-${PARQUET_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/parquet/parquet-avro/${PARQUET_VERSION}/parquet-avro-${PARQUET_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/parquet/parquet-common/${PARQUET_VERSION}/parquet-common-${PARQUET_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/parquet/parquet-encoding/${PARQUET_VERSION}/parquet-encoding-${PARQUET_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/parquet/parquet-format-structures/${PARQUET_VERSION}/parquet-format-structures-${PARQUET_VERSION}.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/parquet/parquet-jackson/${PARQUET_VERSION}/parquet-jackson-${PARQUET_VERSION}.jar && \
    # Additional dependencies
    curl -O https://repo1.maven.org/maven2/org/apache/avro/avro/1.11.1/avro-1.11.1.jar && \
    curl -O https://repo1.maven.org/maven2/com/fasterxml/jackson/core/jackson-databind/2.14.2/jackson-databind-2.14.2.jar && \
    curl -O https://repo1.maven.org/maven2/com/fasterxml/jackson/core/jackson-core/2.14.2/jackson-core-2.14.2.jar && \
    curl -O https://repo1.maven.org/maven2/com/fasterxml/jackson/core/jackson-annotations/2.14.2/jackson-annotations-2.14.2.jar && \
    curl -O https://repo1.maven.org/maven2/org/slf4j/slf4j-api/1.7.36/slf4j-api-1.7.36.jar && \
    curl -O https://repo1.maven.org/maven2/commons-io/commons-io/2.11.0/commons-io-2.11.0.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/httpcomponents/httpclient/4.5.13/httpclient-4.5.13.jar && \
    curl -O https://repo1.maven.org/maven2/org/apache/httpcomponents/httpcore/4.4.14/httpcore-4.4.14.jar && \
    # Failsafe library (required by Iceberg connector)
    curl -O https://repo1.maven.org/maven2/dev/failsafe/failsafe/3.3.2/failsafe-3.3.2.jar && \
    # Move all JARs to connector lib directory
    mv *.jar /usr/share/confluent-hub-components/iceberg-kafka-connect/lib/

# Set proper permissions
RUN chown -R appuser:appuser /usr/share/confluent-hub-components/iceberg-kafka-connect

USER appuser

CMD ["/etc/confluent/docker/run"]